--
title: "ST558-Project-2"
format: html
editor: visual
---

## Prepare for Analysis
```{r}

library(cdlTools)
library(dplyr)
library(gtsummary)
library(knitr)
library(lubridate)
library(readxl)
library(tidyverse)
library(tigris)
library(sf)
library(scales)
library(zipcodeR)

data_00 <- read_xls("US Superstore data.xls") 
colnames(data_00) = gsub(" ", "_", colnames(data_00))

store_dat <- mutate(data_00,`Postal_Code` = normalize_zip(`Postal_Code`), 
                    `Ship_Mode` = as.factor(`Ship_Mode`), 
                    `Quantity`= as.integer(`Quantity`), 
                    `Order_Date` = as.Date(`Order_Date`), 
                    `Ship_Date` = as.Date(`Ship_Date`), 
                    `Month`=  factor(format(`Order_Date`, "%b"), month.abb, ordered = TRUE), 
                    `Year` = year(`Order_Date`), 
                    `Fulfillment` =  as.integer (difftime(`Ship_Date`, `Order_Date`, units = "days")), 
                    `State` = state.abb[match(`State`, state.name)] |>
                      replace_na('DC'),
                     STATEFIPS = str_pad(as.character(fips(`State`, to = "FIPS")), 2, pad = "0"),
                    `Discount` = (`Discount`*100)) |>
  
                     rename(`Sub_Category` = `Sub-Category`) |> select(-`Order_ID`, -`Country`)                         

 store_dat <- zip_code_db |> 
   select(zipcode, county) |> 
   right_join(store_dat, by = c("zipcode"="Postal_Code")) |>
   rename(`Postal_Code` = `zipcode`) |> rename(`County` = `county`)

 
                     

saveRDS(store_dat, file = "store_data.RDS")
write.csv(store_dat,"store_dat.csv")

```

## Numerical Summaries

– Numerical summaries (means, medians, sds, etc.) for quantitative variables at levels of categorical variables
```{r}

#1-way Contingency Tables
cat("1-way Contingency Table for Category", "\n")
table(store_dat$Category)
cat("\n")

cat("1-way Contingency for Table for Region", "\n")
table(store_dat$Region)
cat("\n")

cat("1-way Contingency for State", "\n")
table(store_dat$State)
cat("\n")

cat("1-way Contingency for Month", "\n")
table(store_dat$Month)
cat("\n")

#2-way Contingency Tables
cat("2-way Contingency Table for Category and Region ", "\n")
table(store_dat$Category, store_dat$Region)
cat("\n")

cat("2-way Contingency Table for Category and Sub-Category ", "\n")
table(store_dat$Category, store_dat$Sub_Category)
cat("\n")

cat("2-way Contingency Table for State and Postal Code ", "\n")
store_dat |>
  group_by(State, Postal_Code) |>
  summarize(count = n())

cat("2-way Contingency Table for Category and Month ", "\n")
table(store_dat$Category, store_dat$Month)
cat("\n")

cat("Sales by Category ", "\n")
store_dat |> 
  select(Sales, Category) |> 
  group_by(Category) |>
  summarize(min = min(Sales),  #take inputs from a widget
            q1 = quantile(Sales, 0.25),
            median = median(Sales),
            mean = mean(Sales),
            q3 = quantile(Sales, 0.75),
            max = max(Sales))

cat("Sales by Month ", "\n")
store_dat |> 
  select(Sales, Month) |> 
  group_by(Month) |>
  summarize(min = min(Sales),
            q1 = quantile(Sales, 0.25),
            median = median(Sales),
            mean = mean(Sales),
            q3 = quantile(Sales, 0.75),
            max = max(Sales))

cat("Sales by State ", "\n")
store_dat |> 
  select(Sales, State) |> 
  group_by(State) |>
  summarize(min = min(Sales),
            q1 = quantile(Sales, 0.25),
            median = median(Sales),
            mean = mean(Sales),
            q3 = quantile(Sales, 0.75),
            max = max(Sales))

cat("Profit by Sub-Category ", "\n")
store_dat |> 
  select(Profit, Sub_Category) |> 
  group_by(Sub_Category) |>
  summarize(min = min(Profit),
            q1 = quantile(Profit, 0.25),
            median = median(Profit),
            mean = mean(Profit),
            q3 = quantile(Profit, 0.75),
            max = max(Profit))

```


## Graphical Summaries (Plots)

Create at least six plots.
∗ At least four of these should display multivariate information via the type of graph, by utilizing coloring, grouping, etc.
∗ All plots should have nice labels and titles.
∗ Some kind of faceting should be used somewhere.
∗ At least one plot should be a plot that we didn’t cover in class (say a heatmap or something like that - depends on your data - lots of good examples to consider here https://exts.ggplot2.tidyverse.org/gallery/)

```{r}
#Bar Plots
ggplot(data=store_dat, aes(x = Month)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  labs(title = "Count of Orders by Month", x = "Month", y = "Count by Month")

ggplot(data = store_dat, aes(x = Sub_Category)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  theme(axis.text.x = element_text(angle = 90, vjust=.5, hjust=1)) +
  labs(title = "Count of Orders by Sub-Category", x = "Sub-Category", y = "Count by Sub-Category")

#Side by Side Bar Plots
ggplot(data = store_dat, aes(x= Category , fill = Region)) +
  geom_bar(position = "dodge") +
  labs(x = "Category") +
  scale_fill_discrete("Region") +
  labs(title = "Count of Orders by Region and Category", x = "Category", y = "Count by Region")


#Box Plots
ggplot(store_dat, aes(x = Region, y = Sales , fill = Region)) +
  geom_boxplot() + labs(title = "Boxplot of Sales by Region", x = "Region", y = "Sales") + coord_cartesian(ylim = c(0, 250))


#Histograms
ggplot(store_dat, aes(x = log(Sales), fill = Region)) +
  geom_histogram(aes(y = ..density..), color = 'black', position = "identity") +
  labs(title = "Distribution of Sales by Region", x = "Log Sales", y = "Density")


#Scatter Plots
ggplot(store_dat, aes(x = Order_Date, y = Sales, color = Month)) + 
  geom_point() + geom_jitter(width = 0.5, alpha = 0.3) + 
  labs(title = "Scatterplot of Sales by Month over Time", x = "Date", y = "Sales")


ggplot(store_dat, aes(x = Order_Date, y = Profit, color = Category)) + 
  geom_point() + geom_jitter(width = 0.5, alpha = 0.3) + 
  labs(title = "Scatterplot of Profit by Category over Time", x = "Date", y = "Profit")


#Scatter Plots with Faceting
ggplot(store_dat, aes(x = Order_Date, y = Sales, color = Month)) + 
  geom_point() + geom_jitter(width = 0.5, alpha = 0.3) + 
  labs(title = "Scatterplot of Sales by Sub-Category over Time", x = "Date", y = "Sales") + 
  
 facet_wrap(. ~ Sub_Category, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust=.5, hjust=1))


ggplot(store_dat, aes(x = Order_Date, y = Profit, color = Month)) + 
  geom_point() + geom_jitter(width = 0.5, alpha = 0.3) + 
  labs(title = "Scatterplot of Profit by Sub-Category over Time", x = "Date", y = "Profit") + 
  
 facet_wrap(. ~ Sub_Category, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, vjust=.5, hjust=1))


```


## Chloropeth Map
```{r}

FIPS_fill = aggregate(store_dat$Sales, list(store_dat$STATEFIPS), FUN = sum) |>
rename(`STATEFP` = `Group.1`, Sales = x)

states <- states(cb = TRUE, class = "sf") |>
  filter(!as.numeric(STATEFP) %in% c(2, 15, 60, 66, 69, 72, 78)) |> # lower 48 and DC only
  left_join(FIPS_fill, by = "STATEFP")

states |>
  ggplot(aes(fill = Sales)) +
  geom_sf() + 
  theme_test() +
  scale_fill_gradientn("Sales", colours = rev(scales::hue_pal()(5))) +
  labs(title = "Gradient Map of Store Sales by State")

# chart_src <- alabama %>% 
#   left_join(data, by = c("NAME" = "County"))
```

